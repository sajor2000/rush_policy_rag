name: Rollback Deployment

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to rollback'
        required: true
        type: choice
        options:
          - staging
          - production
      image_tag:
        description: 'Docker image tag to rollback to (e.g., sha-abc123)'
        required: true
        type: string
      reason:
        description: 'Reason for rollback'
        required: true
        type: string

jobs:
  rollback:
    name: Rollback ${{ inputs.environment }}
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ inputs.environment == 'production' && secrets.AZURE_CREDENTIALS_PROD || secrets.AZURE_CREDENTIALS_STAGING }}

      - name: Rollback Backend
        uses: azure/container-apps-deploy-action@v1
        with:
          containerAppName: rush-policy-backend-${{ inputs.environment }}
          resourceGroup: ${{ inputs.environment == 'production' && secrets.AZURE_RESOURCE_GROUP_PROD || secrets.AZURE_RESOURCE_GROUP_STAGING }}
          imageToDeploy: ghcr.io/${{ github.repository }}/backend:${{ inputs.image_tag }}

      - name: Health check after rollback
        run: |
          echo "Waiting for backend to be healthy after rollback..."
          URL="${{ inputs.environment == 'production' && 'https://rush-policy.azurewebsites.net' || 'https://staging-rush-policy.azurewebsites.net' }}"
          for i in {1..30}; do
            if curl -f $URL/health; then
              echo "Backend is healthy after rollback"
              exit 0
            fi
            echo "Attempt $i failed, waiting 10s..."
            sleep 10
          done
          echo "Backend health check failed after rollback"
          exit 1

      - name: Create rollback issue
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[ROLLBACK] ${{ inputs.environment }} rolled back to ${{ inputs.image_tag }}`,
              body: `## Rollback Details

              **Environment**: ${{ inputs.environment }}
              **Rolled back to**: ${{ inputs.image_tag }}
              **Reason**: ${{ inputs.reason }}
              **Triggered by**: @${{ github.actor }}
              **Time**: ${new Date().toISOString()}

              ## Action Required
              - [ ] Investigate root cause
              - [ ] Fix the issue
              - [ ] Create new deployment
              - [ ] Document incident`,
              labels: ['rollback', 'incident', '${{ inputs.environment }}']
            });

      - name: Notify rollback
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              text: `:warning: Rollback executed in ${{ inputs.environment }}`,
              attachments: [{
                color: 'warning',
                fields: [{
                  title: 'Environment',
                  value: '${{ inputs.environment }}',
                  short: true
                }, {
                  title: 'Image Tag',
                  value: '${{ inputs.image_tag }}',
                  short: true
                }, {
                  title: 'Reason',
                  value: '${{ inputs.reason }}',
                  short: false
                }, {
                  title: 'Triggered by',
                  value: '${{ github.actor }}',
                  short: true
                }]
              }]
            }
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
